<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta tags for character encoding and responsive design -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SHT4x Sensor Dashboard</title>

  <!-- External libraries for MQTT, charts, and date handling -->
  <script src="https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* Base styles for the page */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
    }

    /* Main container for the dashboard */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Dashboard title */
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    /* Container for sensor widgets */
    .sensor-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: nowrap; /* Prevent wrapping to the next row */
      gap: 10px; /* Add a small gap between widgets */
    }

    /* Individual sensor widget styling */
    .sensor {
      flex: 1; /* Distribute space equally */
      min-width: 0; /* Prevent flex items from overflowing */
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      box-sizing: border-box; /* Include padding in width calculation */
    }

    /* Icon styling for sensors */
    .sensor-icon {
      font-size: 1.5rem; /* Slightly smaller icons */
      margin-bottom: 8px;
    }

    /* Color for humidity icons */
    .humidity-icon {
      color: #4a90e2;
    }

    /* Color for temperature icons */
    .temp-icon {
      color: #ff6b6b;
    }

    /* Value display styling */
    .value {
      font-size: 1.5rem; /* Slightly smaller value font */
      font-weight: bold;
      margin: 8px 0;
    }

    /* Label styling */
    .label {
      font-size: 0.8rem; /* Smaller label font */
      color: #666;
    }

    /* Container for charts */
    .chart-container {
      height: 300px;
      margin-top: 20px;
      position: relative;
    }

    /* Container for toggle buttons */
    .toggle-container {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    /* Toggle button styling */
    .toggle-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Active toggle button styling */
    .toggle-btn.active {
      background-color: #4a90e2;
      color: white;
    }

    /* Inactive toggle button styling */
    .toggle-btn:not(.active) {
      background-color: #e0e0e0;
      color: #333;
    }

    /* Date/time picker container */
    .datetime-picker {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    /* Date/time picker input styling */
    .datetime-picker input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* Date/time picker button styling */
    .datetime-picker button {
      padding: 8px 12px;
      background-color: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    /* Section for each graph */
    .graph-section {
      margin-bottom: 30px;
    }

    /* Graph title styling */
    .graph-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    /* Download button styling */
    .download-btn {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 20px;
    }

    /* Modal overlay styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
    }

    /* Modal content styling */
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 50%;
      border-radius: 10px;
    }

    /* Close button for modal */
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    /* Hover effect for close button */
    .close:hover {
      color: black;
    }

    /* Form group styling in modal */
    .form-group {
      margin-bottom: 15px;
    }

    /* Label styling in modal */
    .form-group label {
      display: block;
      margin-bottom: 5px;
    }

    /* Input field styling in modal */
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* Download action container in modal */
    .download-action {
      text-align: right;
      margin-top: 20px;
    }

    /* Confirm download button styling */
    #confirmDownload {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    /* Media Query for Smaller Screens - makes widgets responsive */
    @media (max-width: 768px) {
      .sensor-row {
        flex-wrap: wrap; /* Allow wrapping on small screens */
      }
      .sensor {
        width: 48%; /* Two widgets per row on small screens */
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Main container for the dashboard -->
  <div class="container">
    <!-- Dashboard title -->
    <h1>SHT4x Sensor Dashboard</h1>

    <!-- Download data button -->
    <button class="download-btn" id="downloadBtn">Download Data</button>

    <!-- Container for sensor widgets -->
    <div class="sensor-row">
      <!-- Sensor 1 Widget -->
      <div class="sensor">
        <div class="sensor-icon humidity-icon">
          <i class="fas fa-tint"></i>
        </div>
        <div class="value" id="sensor1Humidity">--</div>
        <div class="label">Sensor 1 RH%</div>
        <div class="sensor-icon temp-icon">
          <i class="fas fa-thermometer-half"></i>
        </div>
        <div class="value" id="sensor1Temp">--</div>
        <div class="label">Sensor 1 T°C</div>
      </div>

      <!-- Sensor 2 Widget -->
      <div class="sensor">
        <div class="sensor-icon humidity-icon">
          <i class="fas fa-tint"></i>
        </div>
        <div class="value" id="sensor2Humidity">--</div>
        <div class="label">Sensor 2 RH%</div>
        <div class="sensor-icon temp-icon">
          <i class="fas fa-thermometer-half"></i>
        </div>
        <div class="value" id="sensor2Temp">--</div>
        <div class="label">Sensor 2 T°C</div>
      </div>

      <!-- Sensor 3 Widget -->
      <div class="sensor">
        <div class="sensor-icon humidity-icon">
          <i class="fas fa-tint"></i>
        </div>
        <div class="value" id="sensor3Humidity">--</div>
        <div class="label">Sensor 3 RH%</div>
        <div class="sensor-icon temp-icon">
          <i class="fas fa-thermometer-half"></i>
        </div>
        <div class="value" id="sensor3Temp">--</div>
        <div class="label">Sensor 3 T°C</div>
      </div>

      <!-- Sensor 4 Widget -->
      <div class="sensor">
        <div class="sensor-icon humidity-icon">
          <i class="fas fa-tint"></i>
        </div>
        <div class="value" id="sensor4Humidity">--</div>
        <div class="label">Sensor 4 RH%</div>
        <div class="sensor-icon temp-icon">
          <i class="fas fa-thermometer-half"></i>
        </div>
        <div class="value" id="sensor4Temp">--</div>
        <div class="label">Sensor 4 T°C</div>
      </div>
    </div>

    <!-- Temperature Graph Section -->
    <div class="graph-section">
      <div class="graph-title">Temperature (°C)</div>
      <div class="toggle-container">
        <button class="toggle-btn active" id="tempLiveBtn">Live</button>
        <button class="toggle-btn" id="tempHistoricBtn">Historic</button>
      </div>
      <div class="datetime-picker" id="tempDatetimePicker" style="display: none;">
        <input type="datetime-local" id="tempStartDateTime">
        <input type="datetime-local" id="tempEndDateTime">
        <button id="applyTempDateRange">Apply</button>
      </div>
      <div class="chart-container">
        <canvas id="tempChart"></canvas>
      </div>
    </div>

    <!-- Humidity Graph Section -->
    <div class="graph-section">
      <div class="graph-title">Humidity (%)</div>
      <div class="toggle-container">
        <button class="toggle-btn active" id="humidityLiveBtn">Live</button>
        <button class="toggle-btn" id="humidityHistoricBtn">Historic</button>
      </div>
      <div class="datetime-picker" id="humidityDatetimePicker" style="display: none;">
        <input type="datetime-local" id="humidityStartDateTime">
        <input type="datetime-local" id="humidityEndDateTime">
        <button id="applyHumidityDateRange">Apply</button>
      </div>
      <div class="chart-container">
        <canvas id="humidityChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Modal for Download Data -->
  <div id="downloadModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Select Date and Time Range</h2>
      <div class="form-group">
        <label for="startDateTime">Start Date and Time:</label>
        <input type="datetime-local" id="startDateTime">
      </div>
      <div class="form-group">
        <label for="endDateTime">End Date and Time:</label>
        <input type="datetime-local" id="endDateTime">
      </div>
      <div class="download-action">
        <button id="confirmDownload">Download</button>
      </div>
    </div>
  </div>

  <script>
    // MQTT Client Setup
    const clientId = 'dashboard_' + Math.random().toString(16).substr(2, 8);
    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt', {
      clientId: clientId,
      keepalive: 60,
      clean: true,
    });

    // Store all data for historic view and download
    const allData = {
      sensor1Temp: [], sensor1Humidity: [],
      sensor2Temp: [], sensor2Humidity: [],
      sensor3Temp: [], sensor3Humidity: [],
      sensor4Temp: [], sensor4Humidity: []
    };

    // Track if we're in live or historic mode
    let isTempLive = true;
    let isHumidityLive = true;

    // Temperature Chart Setup
    const tempCtx = document.getElementById('tempChart').getContext('2d');
    const tempChart = new Chart(tempCtx, {
      type: 'line',
      data: {
        datasets: [
          { label: 'Sensor 1 Temp', borderColor: '#ff6b6b', data: [], tension: 0.3 },
          { label: 'Sensor 2 Temp', borderColor: '#ffa500', data: [], tension: 0.3 },
          { label: 'Sensor 3 Temp', borderColor: '#9b59b6', data: [], tension: 0.3 },
          { label: 'Sensor 4 Temp', borderColor: '#e74c3c', data: [], tension: 0.3 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { type: 'time', time: { unit: 'minute' }, title: { display: true, text: 'Time' } },
          y: { title: { display: true, text: 'Temperature (°C)' } }
        }
      }
    });

    // Humidity Chart Setup
    const humidityCtx = document.getElementById('humidityChart').getContext('2d');
    const humidityChart = new Chart(humidityCtx, {
      type: 'line',
      data: {
        datasets: [
          { label: 'Sensor 1 Humidity', borderColor: '#4a90e2', data: [], tension: 0.3 },
          { label: 'Sensor 2 Humidity', borderColor: '#40e0d0', data: [], tension: 0.3 },
          { label: 'Sensor 3 Humidity', borderColor: '#1abc9c', data: [], tension: 0.3 },
          { label: 'Sensor 4 Humidity', borderColor: '#3498db', data: [], tension: 0.3 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { type: 'time', time: { unit: 'minute' }, title: { display: true, text: 'Time' } },
          y: { title: { display: true, text: 'Humidity (%)' } }
        }
      }
    });

    // MQTT Connection Handler
    client.on('connect', () => {
      console.log('Connected to MQTT broker');
      // Subscribe to all sensor topics
      client.subscribe('esp32/sensor1/temp');
      client.subscribe('esp32/sensor1/humidity');
      client.subscribe('esp32/sensor2/temp');
      client.subscribe('esp32/sensor2/humidity');
      client.subscribe('esp32/sensor3/temp');
      client.subscribe('esp32/sensor3/humidity');
      client.subscribe('esp32/sensor4/temp');
      client.subscribe('esp32/sensor4/humidity');
    });

    // Handle incoming MQTT messages
    client.on('message', (topic, message) => {
      const value = parseFloat(message.toString());
      const now = new Date();
      const dataPoint = { x: now, y: value };

      // Only update the UI if we're in live mode
      if (isTempLive || isHumidityLive) {
        // Update the appropriate sensor display
        if (topic === 'esp32/sensor1/temp') {
          document.getElementById('sensor1Temp').textContent = value.toFixed(2);
          if (isTempLive) tempChart.data.datasets[0].data.push(dataPoint);
        } else if (topic === 'esp32/sensor1/humidity') {
          document.getElementById('sensor1Humidity').textContent = value.toFixed(2);
          if (isHumidityLive) humidityChart.data.datasets[0].data.push(dataPoint);
        } else if (topic === 'esp32/sensor2/temp') {
          document.getElementById('sensor2Temp').textContent = value.toFixed(2);
          if (isTempLive) tempChart.data.datasets[1].data.push(dataPoint);
        } else if (topic === 'esp32/sensor2/humidity') {
          document.getElementById('sensor2Humidity').textContent = value.toFixed(2);
          if (isHumidityLive) humidityChart.data.datasets[1].data.push(dataPoint);
        } else if (topic === 'esp32/sensor3/temp') {
          document.getElementById('sensor3Temp').textContent = value.toFixed(2);
          if (isTempLive) tempChart.data.datasets[2].data.push(dataPoint);
        } else if (topic === 'esp32/sensor3/humidity') {
          document.getElementById('sensor3Humidity').textContent = value.toFixed(2);
          if (isHumidityLive) humidityChart.data.datasets[2].data.push(dataPoint);
        } else if (topic === 'esp32/sensor4/temp') {
          document.getElementById('sensor4Temp').textContent = value.toFixed(2);
          if (isTempLive) tempChart.data.datasets[3].data.push(dataPoint);
        } else if (topic === 'esp32/sensor4/humidity') {
          document.getElementById('sensor4Humidity').textContent = value.toFixed(2);
          if (isHumidityLive) humidityChart.data.datasets[3].data.push(dataPoint);
        }

        // Update charts only if in live mode
        if (isTempLive) tempChart.update();
        if (isHumidityLive) humidityChart.update();
      }

      // Always store data for historic view and download
      if (topic === 'esp32/sensor1/temp') {
        allData.sensor1Temp.push(dataPoint);
      } else if (topic === 'esp32/sensor1/humidity') {
        allData.sensor1Humidity.push(dataPoint);
      } else if (topic === 'esp32/sensor2/temp') {
        allData.sensor2Temp.push(dataPoint);
      } else if (topic === 'esp32/sensor2/humidity') {
        allData.sensor2Humidity.push(dataPoint);
      } else if (topic === 'esp32/sensor3/temp') {
        allData.sensor3Temp.push(dataPoint);
      } else if (topic === 'esp32/sensor3/humidity') {
        allData.sensor3Humidity.push(dataPoint);
      } else if (topic === 'esp32/sensor4/temp') {
        allData.sensor4Temp.push(dataPoint);
      } else if (topic === 'esp32/sensor4/humidity') {
        allData.sensor4Humidity.push(dataPoint);
      }
    });

    // Temperature Live/Historic Toggle
    const tempLiveBtn = document.getElementById('tempLiveBtn');
    const tempHistoricBtn = document.getElementById('tempHistoricBtn');
    const tempDatetimePicker = document.getElementById('tempDatetimePicker');

    // Show live temperature data
    tempLiveBtn.addEventListener('click', () => {
      tempLiveBtn.classList.add('active');
      tempHistoricBtn.classList.remove('active');
      tempDatetimePicker.style.display = 'none';
      isTempLive = true;
      resetTempChartToLive();
    });

    // Show historic temperature data
    tempHistoricBtn.addEventListener('click', () => {
      tempHistoricBtn.classList.add('active');
      tempLiveBtn.classList.remove('active');
      tempDatetimePicker.style.display = 'flex';
      isTempLive = false;
    });

    // Reset temperature chart to live view
    function resetTempChartToLive() {
      tempChart.data.datasets.forEach(dataset => dataset.data = []);
      tempChart.update();
    }

    // Add this function to fetch historic data from your backend
    async function fetchHistoricData(sensorId, startDate, endDate) {
      const url = `https://192.168.1.25:5000/api/sensor-data?sensorId=sensor${sensorId}&startDate=${startDate}&endDate=${endDate}`;
      const response = await fetch(url);
      const data = await response.json();
      return data;
    }

    // Update the event listener for the temperature historic button
    document.getElementById('applyTempDateRange').addEventListener('click', async () => {
      const startDateTime = document.getElementById('tempStartDateTime').value;
      const endDateTime = document.getElementById('tempEndDateTime').value;
      if (!startDateTime || !endDateTime) {
        alert("Please select both start and end date/time.");
        return;
      }
      // Fetch historic data for each sensor
      const sensor1Data = await fetchHistoricData(1, startDateTime, endDateTime);
      const sensor2Data = await fetchHistoricData(2, startDateTime, endDateTime);
      const sensor3Data = await fetchHistoricData(3, startDateTime, endDateTime);
      const sensor4Data = await fetchHistoricData(4, startDateTime, endDateTime);
    
      // Update chart with fetched data
      tempChart.data.datasets[0].data = sensor1Data.map(point => ({ x: new Date(point.timestamp), y: point.temperature }));
      tempChart.data.datasets[1].data = sensor2Data.map(point => ({ x: new Date(point.timestamp), y: point.temperature }));
      tempChart.data.datasets[2].data = sensor3Data.map(point => ({ x: new Date(point.timestamp), y: point.temperature }));
      tempChart.data.datasets[3].data = sensor4Data.map(point => ({ x: new Date(point.timestamp), y: point.temperature }));
      tempChart.update();
    });


    // Humidity Live/Historic Toggle
    const humidityLiveBtn = document.getElementById('humidityLiveBtn');
    const humidityHistoricBtn = document.getElementById('humidityHistoricBtn');
    const humidityDatetimePicker = document.getElementById('humidityDatetimePicker');

    // Show live humidity data
    humidityLiveBtn.addEventListener('click', () => {
      humidityLiveBtn.classList.add('active');
      humidityHistoricBtn.classList.remove('active');
      humidityDatetimePicker.style.display = 'none';
      isHumidityLive = true;
      resetHumidityChartToLive();
    });

    // Show historic humidity data
    humidityHistoricBtn.addEventListener('click', () => {
      humidityHistoricBtn.classList.add('active');
      humidityLiveBtn.classList.remove('active');
      humidityDatetimePicker.style.display = 'flex';
      isHumidityLive = false;
    });

    // Reset humidity chart to live view
    function resetHumidityChartToLive() {
      humidityChart.data.datasets.forEach(dataset => dataset.data = []);
      humidityChart.update();
    }

    document.getElementById('applyHumidityDateRange').addEventListener('click', async () => {
      const startDateTime = document.getElementById('humidityStartDateTime').value;
      const endDateTime = document.getElementById('humidityEndDateTime').value;
      if (!startDateTime || !endDateTime) {
        alert("Please select both start and end date/time.");
        return;
      }
      // Fetch historic data for each sensor
      const sensor1Data = await fetchHistoricData(1, startDateTime, endDateTime);
      const sensor2Data = await fetchHistoricData(2, startDateTime, endDateTime);
      const sensor3Data = await fetchHistoricData(3, startDateTime, endDateTime);
      const sensor4Data = await fetchHistoricData(4, startDateTime, endDateTime);
    
      // Update chart with fetched data
      humidityChart.data.datasets[0].data = sensor1Data.map(point => ({ x: new Date(point.timestamp), y: point.humidity }));
      humidityChart.data.datasets[1].data = sensor2Data.map(point => ({ x: new Date(point.timestamp), y: point.humidity }));
      humidityChart.data.datasets[2].data = sensor3Data.map(point => ({ x: new Date(point.timestamp), y: point.humidity }));
      humidityChart.data.datasets[3].data = sensor4Data.map(point => ({ x: new Date(point.timestamp), y: point.humidity }));
      humidityChart.update();
    });


    // Download Modal Logic (remains the same)
    const downloadBtn = document.getElementById('downloadBtn');
    const modal = document.getElementById('downloadModal');
    const closeBtn = document.querySelector('.close');
    const confirmDownload = document.getElementById('confirmDownload');

    downloadBtn.addEventListener('click', () => {
      modal.style.display = 'block';
    });

    closeBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    confirmDownload.addEventListener('click', () => {
      const startDateTime = new Date(document.getElementById('startDateTime').value);
      const endDateTime = new Date(document.getElementById('endDateTime').value);
      if (!startDateTime || !endDateTime) {
        alert("Please select both start and end date/time.");
        return;
      }

      // Generate timestamps for each second in the selected range
      const timestamps = [];
      const currentTime = new Date(startDateTime.getTime());

      while (currentTime <= endDateTime) {
        timestamps.push(new Date(currentTime));
        currentTime.setSeconds(currentTime.getSeconds() + 1);
      }

      if (timestamps.length === 0) {
        alert("No data available for the selected range.");
        return;
      }

      // Prepare CSV content
      let csv = 'Serial No.,Date,Time,Sensor1_Humidity,Sensor1_Temperature,Sensor2_Humidity,Sensor2_Temperature,Sensor3_Humidity,Sensor3_Temperature,Sensor4_Humidity,Sensor4_Temperature\n';

      timestamps.forEach((timestamp, index) => {
        const dateStr = timestamp.toISOString().slice(0, 10);
        const timeStr = timestamp.toISOString().slice(11, 19);

        // Find the closest data points for each sensor
        const findClosestValue = (data, targetTime) => {
          if (data.length === 0) return '';
          const closest = data.reduce((prev, curr) =>
            (Math.abs(curr.x - targetTime) < Math.abs(prev.x - targetTime) ? curr : prev)
          );
          return closest.y;
        };

        const sensor1Humidity = findClosestValue(allData.sensor1Humidity, timestamp) || '';
        const sensor1Temp = findClosestValue(allData.sensor1Temp, timestamp) || '';
        const sensor2Humidity = findClosestValue(allData.sensor2Humidity, timestamp) || '';
        const sensor2Temp = findClosestValue(allData.sensor2Temp, timestamp) || '';
        const sensor3Humidity = findClosestValue(allData.sensor3Humidity, timestamp) || '';
        const sensor3Temp = findClosestValue(allData.sensor3Temp, timestamp) || '';
        const sensor4Humidity = findClosestValue(allData.sensor4Humidity, timestamp) || '';
        const sensor4Temp = findClosestValue(allData.sensor4Temp, timestamp) || '';

        csv += `${index + 1},${dateStr},${timeStr},${sensor1Humidity},${sensor1Temp},${sensor2Humidity},${sensor2Temp},${sensor3Humidity},${sensor3Temp},${sensor4Humidity},${sensor4Temp}\n`;
      });

      // Download CSV
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sensor_data_${startDateTime.toISOString().slice(0, 10)}_to_${endDateTime.toISOString().slice(0, 10)}.csv`;
      a.click();

      // Close modal
      modal.style.display = 'none';
    });
  </script>

</body>
</html>
