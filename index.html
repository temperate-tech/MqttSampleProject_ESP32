confirmDownload.addEventListener('click', () => {
  const startDateTime = new Date(document.getElementById('startDateTime').value);
  const endDateTime = new Date(document.getElementById('endDateTime').value);

  if (!startDateTime || !endDateTime) {
    alert("Please select both start and end date/time.");
    return;
  }

  // Filter and organize data by timestamp
  const timestamps = [...new Set(
    chart.data.datasets.flatMap(dataset =>
      dataset.data
        .filter(point => point.x >= startDateTime && point.x <= endDateTime)
        .map(point => point.x.getTime())
    )
  )].sort((a, b) => a - b);

  if (timestamps.length === 0) {
    alert("No data available for the selected range.");
    return;
  }

  // Prepare CSV content
  let csv = 'Serial No.,Date,Time,Sensor1_Humidity,Sensor1_Temperature,Sensor2_Humidity,Sensor2_Temperature\n';

  timestamps.forEach((timestamp, index) => {
    const date = new Date(timestamp);
    const dateStr = date.toISOString().slice(0, 10);
    const timeStr = date.toISOString().slice(11, 19);

    const sensor1Humidity = chart.data.datasets[1].data.find(point => point.x.getTime() === timestamp)?.y || '';
    const sensor1Temp = chart.data.datasets[0].data.find(point => point.x.getTime() === timestamp)?.y || '';
    const sensor2Humidity = chart.data.datasets[3].data.find(point => point.x.getTime() === timestamp)?.y || '';
    const sensor2Temp = chart.data.datasets[2].data.find(point => point.x.getTime() === timestamp)?.y || '';

    csv += `${index + 1},${dateStr},${timeStr},${sensor1Humidity},${sensor1Temp},${sensor2Humidity},${sensor2Temp}\n`;
  });

  // Download CSV
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sensor_data_${startDateTime.toISOString().slice(0, 10)}_to_${endDateTime.toISOString().slice(0, 10)}.csv`;
  a.click();

  // Close modal
  modal.style.display = 'none';
});
